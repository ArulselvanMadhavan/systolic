âŸ¨âŸ¨red, yellow, green, white, blackâŸ©â‡color, raylibâŸ©â†râ†â€¢Import "../rayed-bqn/rayed.bqn"

tileSize â† 3
dims â† tileSizeâ€¿tileSize
nsize â† Ã—Â´ dims

clock â† r.StartClock@
MkData â† â€¢rand.RangeËœ
activations â† â¥ŠâŸœ(MkData+Â´) dims
weight â† â¥ŠâŸœ(MkData+Â´) dims
expectedOut â† activations +Ëâˆ˜Ã—â‰1â€¿âˆ weight

rdCy â† (2Ã—tileSize)-1
outCy â† tileSize + (tileSize - 1) + tileSize
a1 â† âŒ½Ë˜(â‰activations)
a2 â† ((tileSize - 1) + outCy) â†‘Ë˜ a1
a3 â† (tileSize + (â†•tileSize)) âŒ½Ë˜ a2
a3_ts â† âŒ½âˆ¾Ë(dims â†• a3)

spacing â† 0
min_y â† 20
max_x â† 20
rec â† 20
out_start â† (min_y)â€¿(max_x + (3 Ã— spacing))
out_wid â† 2Ã—rec
out_spacing â† (out_widâ€¿out_wid)
MkGridPts â† {(âŒ½â‰1) (ğ•©âŠ¸+Ë˜out_widÃ—>â¥Šâ†•dims)}
out_tl â† MkGridPts out_start
MkGridLines â† (âˆ¾âŸœout_spacing)Ë˜
act_lines â† MkGridLines out_tl
NextLines â† {ğ•¨ğ•Šğ•©:
          max_x â† âŒˆËâŒˆËğ•©
          min_x â† âŒŠËâŠ‘Ë˜ğ•©
          diff_x â† max_x - min_x
          out â† (âŠ‘diff_x + ğ•¨)â€¿0â€¿0â€¿0âŠ¸+Ë˜ ğ•©
}
x_spacing â† 3Ã—rec
w_lines â† x_spacing NextLines act_lines
out_lines â† x_spacing NextLines w_lines
DrawRectangleLines â† {râ€¿gâ€¿bâ€¿ağ•Šxâ€¿yâ€¿wxâ€¿wy:
raylib.DrawRectangleLinesâŸ¨x, y, wx, wy, râ€¿gâ€¿bâ€¿aâŸ©
}â‰1â€¿2

sys_xâ€¿sys_y â† 40â€¿40
sys_interleave â† {
    bxs â† sys_xâŠ¸Ã—(Ã—Â´ dims)â¥Šâ†•tileSize
    bys â† sys_yâŠ¸Ã—(â¥ŠtileSizeâ¥ŠË˜â†•tileSize)
    out â† bxs âˆ¾Ë˜ bys
    out2 â† 4â†‘Ë˜out
}
spOffXâ€¿spOffY â† 150â€¿170
sys_w_lines â† (sys_interleave + (spOffXâ€¿spOffYâ€¿0â€¿0âŠ¸+Ë˜ w_lines))
MkTxt â† {ğ•¨ğ•Šğ•©:
    sys_w_start â† 2â†‘Ë˜ğ•©
    sys_w_txt_pos â† ((out_widâ€¿out_wid)Ã·2)âŠ¸+Ë˜ sys_w_start
    (<Ë˜ sys_w_txt_pos) âˆ¾Ë˜ (â€¢FmtÂ¨ â¥Šğ•¨)
}
sys_w_txt â† weight MkTxt sys_w_lines
fontSize â† 20

sys_act_lines â† (sys_interleave + (0â€¿spOffYâ€¿0â€¿0âŠ¸+Ë˜ act_lines))
right â† [1, 0]
down â† [0, 1]
up â† Â¯1Ã—down
left â† Â¯1Ã—right
MkLinks â† {ğ•Šğ•©:
    out_st â† 2â†‘Ë˜ğ•©
    up_st â† (right Ã— rec)âŠ¸+Ë˜ out_st
    down_st â† (down Ã— out_wid)âŠ¸+Ë˜ up_st
    left_st â† (down Ã— rec)âŠ¸+Ë˜ out_st
    right_st â† (right Ã— out_wid)âŠ¸+Ë˜ left_st
    ExtendLink â† {ğ•¨ğ•Šğ•©:((âŠ£â‰((âŠ‘ğ•¨) Ã— out_wid)âŠ¸+)Ëœ)Ë˜ (âŠ‘ğ•©)}
    out â† upâ€¿downâ€¿rightâ€¿left ExtendLinkË˜ up_stâ€¿down_stâ€¿right_stâ€¿left_st
    numel â† Ã—Â´(Â¯2â†“â‰¢out)
    numelâ€¿2â€¿2â¥Šout
}

links â† MkLinks sys_w_lines

secs_per_step â† 3
duration â† outCy Ã— secs_per_step
PerFrame â† {ğ•¤
    elapsedSecs â† âŒˆclock.Time@
    secs_idx â†  duration | elapsedSecs
    step_idx â† âŒŠ(secs_idx Ã· secs_per_step)
    # â€¢Show secs_idxâ€¿step_idxâ€¿(step_idx âŠ a3_ts)
    font â† r.font.LoadRaylib@
    {white DrawRectangleLines ğ•©}Ë˜ act_lines
    {white DrawRectangleLines ğ•©}Ë˜ w_lines
    {white DrawRectangleLines ğ•©}Ë˜ out_lines
    {white DrawRectangleLines ğ•©}Ë˜ sys_w_lines
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ sys_w_txt
    {white DrawRectangleLines ğ•©}Ë˜ sys_act_lines
    sys_a_txt â† (step_idx âŠ a3_ts) MkTxt sys_act_lines
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ sys_a_txt
    {white r.draw.Line ğ•©}Ë˜ links
} r.draw._withCanvasâŸœblack

PerFrameâ€¢_While_(Â¬r.window.ShouldClose)r.window._openAs "DistGEMM"

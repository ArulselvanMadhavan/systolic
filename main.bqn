âŸ¨âŸ¨red, yellow, green, white, blackâŸ©â‡color, raylibâŸ©â†râ†â€¢Import "../rayed-bqn/rayed.bqn"

tileSize â† 3
dims â† tileSizeâ€¿tileSize
nsize â† Ã—Â´ dims

clock â† r.StartClock@
MkData â† â€¢rand.RangeËœ
activations â† 1+â¥ŠâŸœ(MkData+Â´) dims
weight â† 1+â¥ŠâŸœ(MkData+Â´) dims
weight2 â† 1+â¥ŠâŸœ(MkData+Â´) dims
MatMul â† {activationsğ•Šweight: activations +Ëâˆ˜Ã—â‰1â€¿âˆ weight}

rdCy â† (2Ã—tileSize)-1
outCy â† tileSize + (tileSize - 1) + tileSize
MkActTs â† {ğ•Šactivations:
    a1 â† âŒ½Ë˜(â‰activations)
    a2 â† ((tileSize - 1) + outCy) â†‘Ë˜ a1
    a3 â†  (tileSize+â†•tileSize)âŒ½Ë˜a2
    a3
}


lt_mat â† â‰¥âŒœËœâ†•tileSize
ut_mat â† Â¬lt_mat
ls_mat â† (<Ë˜(lt_matâˆ¾ut_mat))
zs_mat â† (outCy - (â‰ ls_mat))â†‘(<(tileSizeâ¥Š0))
ts_mat â† ls_mat âˆ¾ zs_mat
ts_mat2 â† (âŒ½âŸœts_mat)Ë˜ (Â¯1Ã—â†•tileSize)
ts_mat3 â† âˆ¾Ë>â‰Ë˜â‰ts_mat2

MkLinkData â† {wğ•Ša3:
    t â† tileSize
    a3_ts â† tâ€¿tâ†•a3
    zs â† tâ€¿(t-1)â¥Š0
    zas â† a3âˆ¾Ë˜zs
    zst â† tâ€¿tâ†•zas
    zst1 â† âŒ½âˆ¾Ëzst
    zmul â† (wâŠ¸Ã—)Ë˜ zst1
    zmul2 â† tâ†•zmul
    SumDown â† {ğ•Šğ•©:
        tt â† (âŒ½â†•t)
        tres â† (tt {(Â»âŸğ•¨)â‰2 ğ•©}Ë˜ ğ•©)
        (t-1)âŠ¸â†“â‰2>tres
    }
    res â† SumDownË˜ zmul2
    res2 â† âˆ¾ËË˜res
    link_data â† +`Ë˜res2
    link_ex â† outCyâ†‘link_data
    link_ex1 â† âˆ¾â‰(<Ë˜link_ex)
    link_ex2 â† (Â¯1Ã—tÃ—(â†•t)) âŒ½Ë˜ link_ex1
    link_ex3 â† â‰Ë˜outCyâ€¿tâ€¿tâ¥Šâ‰link_ex2
    link_ex4 â† (t-1)âŒ½Â¯1âŠË˜ link_ex3
    link_ex3â€¿(âŒ½Ë˜â‰link_ex4)
}


spacing â† 0
min_y â† 20
max_x â† 20
rec â† 20
out_start â† (min_y)â€¿(max_x + (3 Ã— spacing))
out_wid â† 2Ã—rec
out_spacing â† (out_widâ€¿out_wid)
MkGridPts â† {(âŒ½â‰1) (ğ•©âŠ¸+Ë˜out_widÃ—>â¥Šâ†•dims)}
out_tl â† MkGridPts out_start
MkGridLines â† (âˆ¾âŸœout_spacing)Ë˜
act_lines â† MkGridLines out_tl
NextLines â† {ğ•¨ğ•Šğ•©:
    max_x â† âŒˆËâŒˆËğ•©
    min_x â† âŒŠËâŠ‘Ë˜ğ•©
    diff_x â† max_x - min_x
    out â† (âŠ‘diff_x + ğ•¨)â€¿0â€¿0â€¿0âŠ¸+Ë˜ ğ•©
}
BelowLines â† {ğ•¨ğ•Šğ•©:
    max_y â† âŒˆËâŒˆËğ•©
    min_y â† âŒŠË(1âŠ¸âŠ‘)Ë˜ğ•©
    diff_y â† max_y - min_y
    out â† 0â€¿(âŠ‘diff_y + ğ•¨)â€¿0â€¿0âŠ¸+Ë˜ ğ•©
}
FindMaxMin â† {ğ•Šğ•©:
    xy â† Â¯2â†“Ë˜ğ•©
    max_x â† âŠ‘âŒˆË(âŠË˜xy)
    min_x â† âŠ‘âŒŠË(âŠË˜xy)
    max_y â† âŠ‘âŒˆË(1âŠ¸âŠË˜xy)
    min_y â† âŠ‘âŒŠË(1âŠ¸âŠË˜xy)
    min_xâ€¿min_yâ€¿max_xâ€¿max_y
}


x_spacing â† 3Ã—rec
w_lines â† x_spacing NextLines act_lines
out_lines â† x_spacing NextLines w_lines
w_lines2 â† x_spacing NextLines out_lines
out_lines2 â† x_spacing NextLines w_lines2

lines_min_max â† FindMaxMinÂ¨ act_linesâ€¿w_linesâ€¿out_linesâ€¿w_lines2â€¿out_lines2
FindMid â† {ğ•Šğ•©:
     wâ€¿x â† ğ•©
     l_min_xâ€¿l_min_yâ€¿l_max_xâ€¿l_max_y â† w
    r_min_xâ€¿r_min_yâ€¿r_max_xâ€¿r_max_y â† x
    mid_x â† (recÃ·1.5) + l_max_x + (r_min_x - l_max_x)Ã·2
    mid_y â† l_min_y + (l_max_y - l_min_y) Ã· 2
    <(mid_xâ€¿mid_y)
}
mid_out â† FindMidË˜ 2â†•lines_min_max
symbols â† "@"â€¿"="â€¿"@"â€¿"="
symbols_txt â† mid_out âˆ¾Ë˜ symbols
DrawRectangleLines â† {râ€¿gâ€¿bâ€¿ağ•Šxâ€¿yâ€¿wxâ€¿wy:
raylib.DrawRectangleLinesâŸ¨x, y, wx, wy, râ€¿gâ€¿bâ€¿aâŸ©
}â‰1â€¿2

sys_xâ€¿sys_y â† 40â€¿40
sys_interleave â† {
    bxs â† sys_xâŠ¸Ã—(Ã—Â´ dims)â¥Šâ†•tileSize
    bys â† sys_yâŠ¸Ã—(â¥ŠtileSizeâ¥ŠË˜â†•tileSize)
    out â† bxs âˆ¾Ë˜ bys
    out2 â† 4â†‘Ë˜out
}
# FIXME: This offset should be derived from max_y in expected out
spOffXâ€¿spOffY â† 150â€¿170

sys_w_lines â† (sys_interleave + (spOffXâ€¿spOffYâ€¿0â€¿0âŠ¸+Ë˜ w_lines))
sys_w_lines2 â† (0) BelowLines sys_w_lines
MkTxt â† {ğ•¨ğ•Šğ•©:
    sys_w_start â† 2â†‘Ë˜ğ•©
    sys_w_txt_pos â† ((out_widâ€¿out_wid)Ã·4)âŠ¸+Ë˜ sys_w_start
    (<Ë˜ sys_w_txt_pos) âˆ¾Ë˜ (â€¢FmtÂ¨ â¥Šğ•¨)
}
act_txt â† activations MkTxt act_lines
w_txt â† weight MkTxt w_lines
w_txt2 â† weight2 MkTxt w_lines2

sys_w_txt â† weight MkTxt sys_w_lines
sys_w_txt2 â† weight2 MkTxt sys_w_lines2
fontSize â† 20

sys_act_lines â† (sys_interleave + (0â€¿spOffYâ€¿0â€¿0âŠ¸+Ë˜ act_lines))
right â† [1, 0]
down â† [0, 1]
up â† Â¯1Ã—down
left â† Â¯1Ã—right
MkLinks â† {ğ•Šğ•©:
    out_st â† 2â†‘Ë˜ğ•©
    up_st â† (right Ã— rec)âŠ¸+Ë˜ out_st
    down_st â† (down Ã— out_wid)âŠ¸+Ë˜ up_st
    left_st â† (down Ã— rec)âŠ¸+Ë˜ out_st
    right_st â† (right Ã— out_wid)âŠ¸+Ë˜ left_st
    ExtendLink â† {ğ•¨ğ•Šğ•©:((âŠ£â‰((âŠ‘ğ•¨) Ã— out_wid)âŠ¸+)Ëœ)Ë˜ (âŠ‘ğ•©)}
    upâ€¿downâ€¿rightâ€¿left ExtendLinkË˜ up_stâ€¿down_stâ€¿right_stâ€¿left_st
}

out_l1 â† MkLinks sys_w_lines
out_l2 â† MkLinks sys_w_lines2
ProcessLinks â† {ğ•Šout:
  numel â† Ã—Â´(Â¯2â†“â‰¢out)
  numelâ€¿2â€¿2â¥Šout
}
links1 â† ProcessLinks out_l1
links2 â† ProcessLinks out_l2

GetDownMid â† {ğ•Šout_l1:
           up_l1â€¿down_l1â€¿left_l1â€¿right_l1 â† <Ë˜ out_l1
           Ã·âŸœ2Ë˜+ËË˜ down_l1
}
down_mid1 â† GetDownMid out_l1
down_mid2 â† GetDownMid out_l2

act_ts â† (MkActTs activations)
sys_act_ts â† (âŒ½â‰3(âˆ¾Ë((tileSizeâ€¿tileSize)â†•act_ts)))

expectedOut â† activations MatMul weight
expectedOut2 â† expectedOut MatMul weight2

out_txt â† expectedOut MkTxt out_lines
out_txt2 â† expectedOut2 MkTxt out_lines2

link_ts0â€¿linkData â† weight MkLinkData act_ts
link_ts â† Â¯1âŒ½link_ts0
ProcessOut â† {ğ•Šğ•©:
  lz â† (tileSizeâ€¿(tileSize - 1))â¥Š0
  lzâˆ¾Ë˜ğ•©
}
linkOut â† ProcessOut linkData
link_ts2â€¿linkData2 â† weight2 MkLinkData linkOut

secs_per_step â† 4
totalMatMuls â† 2
nonOverlap_step â† ((tileSize + 1))
matmul_switch_freq â†  (totalMatMuls - 1) Ã— nonOverlap_step Ã— secs_per_step
lastMatmul â† outCy Ã— secs_per_step
duration â† matmul_switch_freq + lastMatmul


nonOverlap_zs â† ((totalMatMuls - 1) Ã— nonOverlap_step)â€¿tileSizeâ€¿tileSize â¥Š 0
# FIXME: This will work only for two matmuls but the
link_ts_o â† >(<Ë˜link_ts) âˆ¾ (<Ë˜nonOverlap_zs)
link_ts2_o â† >(<Ë˜nonOverlap_zs) âˆ¾ (<Ë˜link_ts2)
sys_act_ts_o â† >(<Ë˜sys_act_ts) âˆ¾ (<Ë˜nonOverlap_zs)

PerFrame â† {ğ•¤
    elapsedSecs â† âŒˆclock.Time@
    secs_idx â†  duration | elapsedSecs
    step_idx â† âŒŠ(secs_idx Ã· secs_per_step)
    link1_data â† step_idx âŠ link_ts_o
    link2_data â† step_idx âŠ link_ts2_o
    font â† r.font.LoadRaylib@
    {white DrawRectangleLines ğ•©}Ë˜ act_lines
    {white DrawRectangleLines ğ•©}Ë˜ w_lines
    {white DrawRectangleLines ğ•©}Ë˜ out_lines
    {white DrawRectangleLines ğ•©}Ë˜ w_lines2
    {white DrawRectangleLines ğ•©}Ë˜ out_lines2
    {white DrawRectangleLines ğ•©}Ë˜ sys_w_lines
    {white DrawRectangleLines ğ•©}Ë˜ sys_w_lines2
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ act_txt
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ w_txt
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ out_txt
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ w_txt2
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ out_txt2
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ sys_w_txt
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ sys_w_txt2
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ symbols_txt
    {white DrawRectangleLines ğ•©}Ë˜ sys_act_lines
    sys_a_txt â† (step_idx âŠ sys_act_ts_o) MkTxt sys_act_lines
    {whiteâ€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ sys_a_txt
    color1 â† >(âŠ‘âŸœwhiteâ€¿green)Â¨ ((0âŠ¸â‰ )Â¨ â¥Šlink1_data)
    color1 {ğ•¨â€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ ((<Ë˜down_mid1) âˆ¾Ë˜ (â€¢Fmt Â¨(â¥Šlink1_data)))
    {white r.draw.Line ğ•©}Ë˜ links1
    color2 â† >(âŠ‘âŸœwhiteâ€¿green)Â¨ ((0âŠ¸â‰ )Â¨ â¥Šlink2_data)
    color2 {ğ•¨â€¿fontâ€¿fontSize r.draw.Text ğ•©}Ë˜ ((<Ë˜down_mid2) âˆ¾Ë˜ (â€¢Fmt Â¨(â¥Šlink2_data)))
    {white r.draw.Line ğ•©}Ë˜ links2

} r.draw._withCanvasâŸœblack

PerFrameâ€¢_While_(Â¬r.window.ShouldClose) r.window._openAs "DistGEMM"
